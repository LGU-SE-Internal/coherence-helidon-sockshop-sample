---
apiVersion: v1
kind: ConfigMap
metadata:
  name: loadgen-config
  labels:
    app: loadgen
data:
  config.yaml: |
    # Load Generator Configuration for Coherence Helidon Sock Shop
    #
    # This file allows you to customize load patterns and API call distributions
    # without modifying the Python code.

    # Load test scenarios
    scenarios:
      # Light load - simulate typical off-peak traffic
      light:
        users: 10
        spawn_rate: 2
        run_time: "5m"
        description: "Light load scenario for basic testing and validation"
        
      # Medium load - simulate normal business hours
      medium:
        users: 50
        spawn_rate: 5
        run_time: "15m"
        description: "Medium load scenario for typical production traffic"
        
      # Heavy load - simulate peak shopping periods (Black Friday, holidays)
      heavy:
        users: 200
        spawn_rate: 10
        run_time: "30m"
        description: "Heavy load scenario for stress testing"
        
      # Spike test - sudden traffic surge
      spike:
        users: 500
        spawn_rate: 50
        run_time: "10m"
        description: "Spike test to verify system resilience under sudden load"

    # API endpoint weights (must sum to 100)
    # These weights reflect realistic e-commerce user behavior
    api_weights:
      browse_catalogue: 40      # Users mostly browse products
      view_product_details: 30  # View specific product information
      user_login_flow: 10       # Registration and authentication
      shopping_cart: 15         # Add/remove/update cart items
      place_order: 5            # Actual purchase conversions

    # User behavior configuration
    user_behavior:
      min_wait: 1.0    # Minimum wait time between actions (seconds)
      max_wait: 3.0    # Maximum wait time between actions (seconds)
      
      # Probabilities for various user actions (0.0 to 1.0)
      probabilities:
        view_image: 0.5           # Chance of viewing product image
        register_on_login_fail: 0.3  # Chance of registering after failed login
        add_to_cart: 0.7          # Chance of adding item to cart during cart operations
        modify_cart_item: 0.2     # Chance of updating or deleting cart item
        delete_vs_update: 0.5     # When modifying, chance of delete vs update

---
apiVersion: v1
kind: Service
metadata:
  name: loadgen
  labels:
    app: loadgen
spec:
  type: ClusterIP
  ports:
    - port: 8089
      targetPort: 8089
      protocol: TCP
      name: web
  selector:
    app: loadgen

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loadgen
  labels:
    app: loadgen
spec:
  replicas: 1
  selector:
    matchLabels:
      app: loadgen
  template:
    metadata:
      labels:
        app: loadgen
    spec:
      containers:
      - name: loadgen
        image: 10.10.10.240/library/ss-loadgen:1c9c7eff
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8089
          protocol: TCP
        # Run locust in headless mode without time limit (continuous load generation)
        # To adjust load: modify --users and --spawn-rate arguments
        # To stop: delete the deployment or scale replicas to 0
        command: ["locust"]
        args:
          - "-f"
          - "locustfile.py"
          - "--host=$(TARGET_HOST)"
          - "--users=50"           # Number of concurrent users
          - "--spawn-rate=5"       # Users spawned per second
          - "--headless"           # Run without web UI
          # No --run-time specified = runs indefinitely
        env:
        - name: TARGET_HOST
          value: "http://front-end.sockshop.svc.cluster.local"
        - name: LOCUST_MIN_WAIT
          value: "1"
        - name: LOCUST_MAX_WAIT
          value: "3"
        volumeMounts:
        - name: config
          mountPath: /loadgen/config.yaml
          subPath: config.yaml
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
      volumes:
      - name: config
        configMap:
          name: loadgen-config
