{{- if .Values.orders.enabled }}
apiVersion: coherence.oracle.com/v1
kind: Coherence
metadata:
  name: {{ .Values.orders.name }}
  labels:
    {{- include "sockshop.service.labels" (dict "name" .Values.orders.name) | nindent 4 }}
spec:
  cluster: {{ .Values.global.coherenceCluster }}
  role: Orders
  replicas: {{ .Values.orders.replicas }}
  image: {{ include "sockshop.image" (dict "global" .Values.global "image" .Values.orders.image) }}
  readinessProbe:
    initialDelaySeconds: {{ .Values.coherence.readinessProbe.initialDelaySeconds }}
    periodSeconds: {{ .Values.coherence.readinessProbe.periodSeconds }}
  application:
    type: helidon
  annotations:
    {{- include "sockshop.otel.podAnnotations" . | nindent 4 }}
  jvm:
    memory:
      heapSize: {{ .Values.coherence.jvm.memory.heapSize }}
    args:
      {{- toYaml .Values.coherence.jvm.args | nindent 6 }}
  coherence:
    metrics:
      enabled: {{ .Values.coherence.metrics.enabled }}
  env:
    - name: OTEL_JAVA_GLOBAL_AUTOCONFIGURE_ENABLED
      value: "true"
    - name: OTEL_INSTRUMENTATION_GRPC_ENABLED
      value: "false"
    - name: OTEL_JAVAAGENT_DEBUG
      value: "true"
    - name: GRPC_TRACE
      value: "all" # 追踪所有信息
    - name: GRPC_VERBOSITY
      value: "DEBUG" # 开启调试级别
  ports:
    - name: http
      port: 7001
      service:
        name: {{ .Values.orders.service.name }}
        port: {{ .Values.orders.service.port }}
      serviceMonitor:
        enabled: {{ .Values.coherence.serviceMonitor.enabled }}
    - name: metrics
      serviceMonitor:
        enabled: {{ .Values.coherence.serviceMonitor.enabled }}
{{- end }}
